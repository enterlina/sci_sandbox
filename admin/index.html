<!DOCTYPE html>
<html lang="en">
  <head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body >
    <div id="message"></div>
    <form id="admin-form">
      Тип: 
      <select name="type" id="optionSelector">
        <option></option>
        <option value="Research">Исследование</option>
        <option value="Startup">Стартап</option>
      </select>
      <div id="root">

      </div>
      <input type="button" id="save" name="save" value="Save">
    </form>
    
  </body>
  <script>
    const root = document.getElementById('root');
    const researchElements = [
      {
        tag: 'input',
        type: "text",
        title: "Название",
        name: "name",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Видео",
        name: "video", 
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Сфера",
        name: "sphere",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Авторы",
        name: "_author",
        id: "_author",
        isMultilang: false,
        isArray: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Кастом автор (Имя)",
        name: "custom_author_name",
        id: "custom_author",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Кастом автор (контакты). Формат ввода заголовокСсылки, ссылка; заголовокСсылки, ссылка",
        name: "custom_author_contacts",
        id: "custom_author_contacts",
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Кастом автор (описание).",
        name: "custom_author_description",
        id: "custom_author_description",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Цель",
        name: "goal",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Проблема",
        name: "problem",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Решение и новизна",
        name: "solution",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Методы",
        name: "methods",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Рекомендации",
        name: "recommendation",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Применение",
        name: "use",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Ключевые слова",
        name: "tags",
        isMultilang: true,
        isArray: true
      },
      {
        tag: 'input',
        type: "date",
        title: "Дата",
        name: "date",
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Скачать",
        name: "download",
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Стиль",
        name: "style",
        isMultilang: false
      }

    ]

    const startupElements = [
      {
        tag: 'input',
        type: "text",
        title: "Название",
        name: "name",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Сфера",
        name: "sphere",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Авторы",
        name: "_author",
        id: "_author",
        isMultilang: false,
        isArray: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Кастом автор (Имя)",
        name: "custom_author_name",
        id: "custom_author",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Кастом автор (контакты). Формат ввода заголовокСсылки, ссылка; заголовокСсылки, ссылка",
        name: "custom_author_contacts",
        id: "custom_author_contacts",
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Кастом автор (описание).",
        name: "custom_author_description",
        id: "custom_author_description",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Видео",
        name: "video", 
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Презентация",
        name: "presentation", 
        isMultilang: false
      },
      {
        tag: 'input',
        type: "text",
        title: "Стадия",
        name: "stage",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Контакты",
        name: "contacts",
        id: "contacts",
        isMultilang: false
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Проблема",
        name: "problem",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Решение",
        name: "solution",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Демо",
        name: "demo",
        isMultilang: false
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Кого ищем",
        name: "needTofind",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Навыки",
        name: "skills",
        isMultilang: true
      },
      {
        tag: 'textarea',
        type: "text",
        title: "Ключевые слова",
        name: "tags",
        isMultilang: true,
        isArray: true
      },
      {
        tag: 'textarea',
        title: "Инфо",
        name: "info",
        isMultilang: true
      },
      {
        tag: 'input',
        type: "text",
        title: "Стиль",
        name: "style",
        isMultilang: false
      }

    ]


    let wrapper = document.createElement('div');
    let optionSelector = document.getElementById('optionSelector');
    let saveBtn = document.getElementById('save');
    let form = document.getElementById('admin-form');
    let message = document.getElementById('message');
    

    saveBtn.addEventListener('click', () => {
      let result = JSON.stringify(convertData(form.elements));
      console.log(convertData(form.elements));
      fetch('http://localhost:8083/api/card/add', {
          method: 'post',
          body: result,
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'Content-Type': 'application/json'
          }
      })
      .then((result)=>{
        message.innerHTML = result.statusText;
      })
    })
    
    function convertData(elements) {
      let result = {};
      for(let i = 0; i < elements.length; i++) {
        let field = elements[i];
        let name = field.name;
        if(name.indexOf('_en') == -1 && name != "save") {
          let isArray = field.dataset.isarray == 'true' ? true : false;
          if(elements[name + '_en'] == undefined) {
            
            result[name] = isArray ? field.value.split(',') : field.value;
            console.log(isArray, result[name])
          } else {
            result[name] = [];
            result[name].push({
              "ru": isArray ? field.value.split(',') : field.value
            })
            if(elements[name + '_en'].value.length != 0) {      
              result[name].push({
                "en": isArray ? elements[name + '_en'].value.split(',') : elements[name + '_en'].value
              })
            }
          }
        } 
      }
      if(result.custom_author_contacts != undefined && result.custom_author_description != undefined && result.custom_author_name != undefined && result.custom_author_contacts != '' && result.custom_author_description!='' && result.custom_author_name != ''){
        let contacts = result.custom_author_contacts.split(';');
        let contactsArr = []

        contacts.map((item) => {
          contactsArr.push(item.split(','))
        })

        let customAuthor = [
          {
            name: result.custom_author_name,
            description: result.custom_author_description,
            contacts: contactsArr
          }
        ]

        result.customAuthor = customAuthor;

        delete result.custom_author_name;
        delete result.custom_author_description;
        delete result.custom_author_contacts;
      } 
      return result;
    }

    function renderFields(item) {
      let row = document.createElement('p');
      row.innerText = item.title + ': ';
      let element = document.createElement(item.tag);
          element.setAttribute('id', item.id ? item.id : item.name);
          element.setAttribute('type', item.type);
          element.setAttribute('name', item.name);
          element.setAttribute('data-isarray', item.isArray ? item.isArray : false);
          row.appendChild(element);

          if(item.isMultilang) {
            let elementEn = document.createElement(item.tag);
            elementEn.setAttribute('id', item.id ? item.id + '_en' : item.name + '_en');
            elementEn.setAttribute('type', item.type);
            elementEn.setAttribute('placeholder', 'English version');
            elementEn.setAttribute('name', item.name + '_en');
            element.setAttribute('isArray', item.isArray ? item.isArray : false);

            row.appendChild(elementEn);
          }

          wrapper.appendChild(row)
    }

    optionSelector.addEventListener('change', function() {
      if(this.value == "Research") {
        wrapper.innerHTML = '';
        root.innerHTML = '';
        researchElements.map(renderFields);
        root.appendChild(wrapper);
      } else if(this.value == "Startup") {
        wrapper.innerHTML = '';
        root.innerHTML = '';
        startupElements.map(renderFields);
        root.appendChild(wrapper);
      }
      message.innerHTML = '';
    })



  </script>

</html>